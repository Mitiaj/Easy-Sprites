@import "media-queries";

$icons-map: 'icons' !default;

$map: sprite-map("#{$icons-map}/*.png", $layout: smart);
$map-retina: sprite-map("#{$icons-map}@x2/*.png", $layout: smart);
$half: 50%;

%comma-separated {
  @each $item in $icons-map {
    background: $map no-repeat;
  }
}

%comma-separated-retina {
  @each $item in $icons-map {
    @media only screen and (min-resolution: 2dppx), (-webkit-min-device-pixel-ratio: 2.0) {
      background: $map-retina no-repeat;
    }
  }
}

//TODO (use pseudo is optional)
$use-pseudo-icon: false !default;
//TODO add ability to switch off comma-separated classes.

@mixin sprites($class, $name, $icons-map: icons, $hover: false, $active: false, $size: true, $retina: true, $center: false, $center-y: false, $center-x: false) {
  //fixme find betterplace for variables
  $sprite-hover: $name + -hover;
  $sprite-active: $name + -active;
  $image-width: image-width(sprite-file($map, $name));
  $image-height: image-height(sprite-file($map, $name));
  //
  #{$class} {
    @content;
    background-position: sprite-position($map, $name);
    @extend %comma-separated;

    @if $size {
      width: $image-width;
      height: $image-height;
      overflow: hidden;
    }

    @if $center {
      position: absolute;
      top: $half;
      left: $half;
      margin-top: -($image-height / 2);
      margin-left: -($image-width / 2);
    } @else if $center-y {
      position: absolute;
      top: $half;
      margin-top: -($image-height / 2);
    } @else if $center-x {
      position: absolute;
      left: $half;
      margin-left: -($image-width / 2);
    }

  }

  @if $use-pseudo-icon {
    @if $hover {
      #{$class} {
        &:hover {
          &:after {
            content: "";
            background-position: sprite-position($map, $sprite-hover);
          }
        }
      }
    }

    @if $active {
      #{$class} {
        &:active {
          &:after {
            content: "";
            background-position: sprite-position($map, $sprite-active);
          }
        }
      }
    }
  } @else {
    @if $hover {
      #{$class} {
        &:hover {
          background-position: sprite-position($map, $sprite-hover);
        }
      }
    }

    @if $active {
      #{$class} {
        &:active {
          background-position: sprite-position($map, $sprite-active);
        }
      }
    }
  }

  @if $retina {
    #{$class} {
      @extend %comma-separated-retina;
      @include respond-to(retina) {
        $position: sprite-position($map-retina, $name);
        background-position: round(nth($position, 1) / 2) round(nth($position, 2) / 2);
        background-size: (ceil(image-width(sprite-path($map-retina)) / 2) auto);
      }
    }
  }

}

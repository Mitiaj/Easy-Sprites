$icons-map: 'icons' !default;
$retina-sprite: false !default;
//TODO fully implement
$comma-separated: true !default;

//  %comma-separated-retina {
//    $m-retina: sprite-map("#{$icons-map}@x2/*.png", $layout: smart);
//    @each $item in $icons-map {
//      @media only screen and (min-resolution: 2dppx), (-webkit-min-device-pixel-ratio: 2.0) {
//        background: $m-retina no-repeat;
//      }
//    }
//  }

@function size-retina($map-retina) {
  @return ((ceil(image-width(sprite-path($map-retina)) / 2) auto));
}

@function position($map, $default-name: false, $hover-name: false) {
  @if $default-name {
    @return (sprite-position($map, $default-name));
  }
  @if $hover-name {
    @return (sprite-position($map, $hover-name));
  }
}

@function position-retina($map, $default-name: false, $hover-name: false) {
  @if $default-name {
    @return (
    round(nth(sprite-position($map, $default-name), 1) / 2)
    round(nth(sprite-position($map, $default-name), 2) / 2)
    );
  }
  @if $hover-name {
    @return (
    round(nth(sprite-position($map, $hover-name), 1) / 2)
    round(nth(sprite-position($map, $hover-name), 2) / 2)
    );
  }
}

@mixin _center($center, $half, $image-height, $image-width, $center-y, $center-x) {
  @if $center {
    position: absolute;
    top: $half;
    left: $half;
    margin: {
      top: -($image-height / 2);
      left: -($image-width / 2);
    }
  } @else if $center-y {
    position: absolute;
    top: $half;
    margin: {
      top: -($image-height / 2);
    }
  } @else if $center-x {
    position: absolute;
    left: $half;
    margin: {
      left: -($image-width / 2);
    }
  }
}

@mixin _center-retina($center, $retina-image-height, $retina-image-width, $center-y, $center-x) {
  @if $center {
    margin: {
      top: -($retina-image-height / 2);
      left: -($retina-image-width / 2);
    }
  } @else if $center-y {
    margin: {
      top: -($retina-image-height / 2);
    }
  } @else if $center-x {
    margin: {
      left: -($retina-image-width / 2);
    }
  }
}

@mixin _comma-separated($name) {
  $map: sprite-map("#{$icons-map}/*.png", $layout: smart);
  @if $comma-separated {
    background-position: position($map, $name);
  } @else {
    background: $map no-repeat position($map, $name);
  }
}

@mixin _comma-separated-retina($name) {
  $map-retina: sprite-map("#{$icons-map}@x2/*.png", $layout: smart);
  @if $comma-separated {
    background-position: position($map-retina, $name);
  } @else {
    background: $map-retina no-repeat position($map-retina, $name);
  }
  background-size: size-retina($map-retina);
}

@mixin sprites($class, $name, $hover: false, $pseudo: true, $size: true, $center: false, $center-y: false, $center-x: false) {
  $map: sprite-map("#{$icons-map}/*.png", $layout: smart);
  $half: 50%;
  $hover-name: $name + -hover;
  $image-width: image-width(sprite-file($map, $name));
  $image-height: image-height(sprite-file($map, $name));

  @if $pseudo {
    #{$class} {
      &:after {
        content: "";
        @include _center($center, $half, $image-height, $image-width, $center-y, $center-x);

        @include _comma-separated($name);

        @if $size {
          width: $image-width;
          height: $image-height;
        }

        @content;
      }

      @if $hover {
        &:hover {
          &:after {
            background-position: position($map, $hover-name);
          }
        }
      }

    }
  } @else {
    #{$class} {
      @include _center($center, $half, $image-height, $image-width, $center-y, $center-x);

      @include _comma-separated($name);

      @if $size {
        width: $image-width;
        height: $image-height;
      }

      @content;

      @if $hover {
        &:hover {
          background-position: position($map, $hover-name);
        }
      }

    }
  }
  @if $retina-sprite {
    $map-retina: sprite-map("#{$icons-map}@x2/*.png", $layout: smart);
    $retina-image-width: (image-width(sprite-file($map-retina, $name)) / 2);
    $retina-image-height: (image-height(sprite-file($map-retina, $name)) / 2);

    @media only screen and (min-resolution: 2dppx), (-webkit-min-device-pixel-ratio: 2.0) {
      @if $pseudo {
        #{$class} {
          &:after {
            @include _center-retina($center, $retina-image-height, $retina-image-width, $center-y, $center-x);

            @include _comma-separated-retina($name);

            @if $size {
              width: $retina-image-width;
              height: $retina-image-height;
            }

            @if $hover {
              &:hover {
                &:after {
                  background-position: position-retina($map-retina, $hover-name);
                }
              }
            }

          }
        }
      } @else {
        #{$class} {
          @include _center-retina($center, $retina-image-height, $retina-image-width, $center-y, $center-x);

          @include _comma-separated-retina($name);

          @if $size {
            width: $retina-image-width;
            height: $retina-image-height;
          }

          @if $hover {
            &:hover {
              background-position: position-retina($map-retina, $hover-name);
            }
          }

        }
      }
    }
  }
}

//TODO get classes list from mixin argument!;
$class-list: '.test', '.set', '.get';

//$class-list:;

@mixin _sprites-comma($class, $name) {
  @include sprites($class, $name) {
  }
}

@if $comma-separated {

  $global-class: ();

  @each $item in $class-list {
    $global-class: append($global-class, unquote($item), comma);
  }

  #{$global-class} {
    $map: sprite-map("#{$icons-map}/*.png", $layout: smart);
    background: $map no-repeat;
  }

  @media only screen and (min-resolution: 2dppx), (-webkit-min-device-pixel-ratio: 2.0) {
    #{$global-class} {
      $map-retina: sprite-map("#{$icons-map}@x2/*.png", $layout: smart);
      background: $map-retina no-repeat;
    }
  }

}

//TODO find better implementation of adding any icon i.e. .active or opened state
@mixin sprite-state($name) {
  $map: sprite-map("#{$icons-map}@x2/*.png", $layout: smart);
  background-position: position($map, $name);
  @if $retina-sprite {
    @media only screen and (min-resolution: 2dppx), (-webkit-min-device-pixel-ratio: 2.0) {
      $map-retina: sprite-map("#{$icons-map}@x2/*.png", $layout: smart);
      background-position: position-retina($map-retina, $name);
      background-size: size-retina($map-retina);
    }
  }
}

@debug "retina sprite map enabled: => #{$retina-sprite}";
@debug "icons map folder: => #{$icons-map}";
@debug "comma separated enabled: => #{$comma-separated}";
//@warn #{sprite-map-name('icons')};

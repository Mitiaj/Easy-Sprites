$icons-map: 'icons' !default;

$map: sprite-map("#{$icons-map}/*.png", $layout: smart);
$map-retina: sprite-map("#{$icons-map}@x2/*.png", $layout: smart);
$half: 50%;

%comma-separated {
  @each $item in $icons-map {
    background: $map no-repeat;
  }
}

%comma-separated-retina {
  @each $item in $icons-map {
    @media only screen and (min-resolution: 2dppx), (-webkit-min-device-pixel-ratio: 2.0) {
      background: $map-retina no-repeat;
    }
  }
}

//noinspection SassScssUnresolvedFunction
@function position($map, $name) {
  @return (sprite-position($map, $name));
}

//noinspection SassScssUnresolvedFunction
@function size-retina($map-retina) {
  @return ((ceil(image-width(sprite-path($map-retina)) / 2) auto));
}

//noinspection SassScssUnresolvedFunction
@function position-retina($map-retina, $sprite-name: false, $hover-name: false, $active-name: false) {

  @if $sprite-name {
    @return (
    round(nth(sprite-position($map-retina, $sprite-name), 1) / 2)
    round(nth(sprite-position($map-retina, $sprite-name), 2) / 2)
    );
  }
  @if $hover-name {
    @return (
    round(nth(sprite-position($map-retina, $hover-name), 1) / 2)
    round(nth(sprite-position($map-retina, $hover-name), 2) / 2)
    );
  }
  @if $active-name {
    @return (
    round(nth(sprite-position($map-retina, $active-name), 1) / 2)
    round(nth(sprite-position($map-retina, $active-name), 2) / 2)
    );
  }

}

//TODO add ability to switch off comma-separated classes. $comma-separated: true !default;
@mixin sprites($class, $name, $icons-map: icons, $hover: false, $active: false, $pseudo: false, $size: true, $retina: true, $center: false, $center-y: false, $center-x: false) {
  $hover-name: $name + -hover;
  $active-name: $name + -active;
  $image-width: image-width(sprite-file($map, $name));
  $image-height: image-height(sprite-file($map, $name));

  @if $pseudo {
    #{$class} {
      @content;
      &:after {
        @extend %comma-separated;
        content: "";
        background-position: position($map, $name);
        @if $size {
          width: $image-width;
          height: $image-height;
          overflow: hidden;
        }
        @if $center {
          position: absolute;
          top: $half;
          left: $half;
          margin-top: -($image-height / 2);
          margin-left: -($image-width / 2);
        } @else if $center-y {
          position: absolute;
          top: $half;
          margin-top: -($image-height / 2);
        } @else if $center-x {
          position: absolute;
          left: $half;
          margin-left: -($image-width / 2);
        }
      }

      @if $hover {
        &:hover {
          &:after {
            background-position: sprite-position($map, $hover-name);
          }
        }
      }

      @if $active {
        &:active {
          &:after {
            background-position: sprite-position($map, $active-name);
          }
        }
      }
    }
  } @else {
    #{$class} {
      @content;
      @extend %comma-separated;
      background-position: position($map, $name);
      @if $size {
        width: $image-width;
        height: $image-height;
        overflow: hidden;
      }

      @if $hover {
        &:hover {
          background-position: sprite-position($map, $hover-name);
        }
      }

      @if $active {
        &:active {
          background-position: sprite-position($map, $active-name);
        }
      }
    }
  }

  @if $retina {
    @media only screen and (min-resolution: 2dppx), (-webkit-min-device-pixel-ratio: 2.0) {

      @if $pseudo {
        #{$class} {
          @content;
          &:after {
            @extend %comma-separated-retina;
            background-position: position-retina($map-retina, $name);
            background-size: size-retina($map-retina);
          }

          @if $hover {
            &:hover {
              &:after {
                background-position: position-retina($map-retina, $hover-name);
              }
            }
          }

          @if $active {
            &:active {
              &:after {
                background-position: position-retina($map-retina, $active-name);
              }
            }
          }
        }
      } @else {
        #{$class} {
          @content;
          @extend %comma-separated-retina;
          background-position: position-retina($map-retina, $name);
          background-size: size-retina($map-retina);
          @if $hover {
            &:hover {
              background-position: position-retina($map-retina, $hover-name);
            }
          }
          @if $active {
            &:active {
              background-position: position-retina($map-retina, $active-name);
            }
          }
        }
      }

    }
  }

}
